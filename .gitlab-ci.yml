image: registry.devops.ukfast.co.uk/default-containers/php/ci:71

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - vendor/

before_script:
- eval $(ssh-agent -s)
- echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
- mkdir -p ~/.ssh
- chmod 700 ~/.ssh
- ssh-keyscan gitlab.devops.ukfast.co.uk >> ~/.ssh/known_hosts
- chmod 644 ~/.ssh/known_hosts
- mv .env.testing .env

stages:
- Build
- Standards
- Tests

check_syntax:
  stage: Build
  tags:
  - rnd
  - php
  artifacts:
    expire_in: 10 mins
    paths:
    - vendor/
  script:
    - composer install
    - ls -lha vendor
    - '! find . -path ./vendor -prune -o -type f -name "*.php" -exec php -l "{}" \; | grep -iv "No syntax errors detected";'

unit_tests:
  stage: Tests
  tags:
  - rnd
  - php
  artifacts:
    expire_in: 10 mins
    paths:
    - vendor/
  script:
  - vendor/bin/phpunit --coverage-text --colors=never

php_cs:
  stage: Standards
  tags:
  - rnd
  - php
  artifacts:
    expire_in: 10 mins
    paths:
    - vendor/
  script:
  - vendor/bin/phpcs --standard=vendor/ukfast/rulesets/CodeSniffer/UKFDefault.xml app

php_md:
  stage: Standards
  allow_failure: true
  tags:
  - rnd
  - php
  artifacts:
    expire_in: 10 mins
    paths:
    - vendor/
  script:
  - vendor/bin/phpmd app text vendor/ukfast/rulesets/MessDetector/UKFDefault.xml

debugging_check:
  stage: Standards
  tags:
    - rnd
    - php
  artifacts:
    expire_in: 10 mins
    paths:
    - vendor/
  script:
  - export PHP_FILES=$(git diff --diff-filter=d --name-only master | grep '.php')
  - 'if [ -n "$PHP_FILES" ]; then ! echo "$PHP_FILES" | xargs grep -irnP "\bprint_r\s*\((?!.*,.*).*\)|\b(?:var_dump|dd)\s*\(.*\)"; fi'
